<div class="container mt-3">
  <h1><%= @post.title %></h1>
  
  <% if @post.images.attached? %>
    <div class="row d-flex justify-content-center">
      <% @post.images.each do |image| %>
        <div class="col-md-4 mb-3 d-flex align-items-center justify-content-center bg-light p-3" style="height: 300px;">
          <%= image_tag image.variant(resize_to_limit: [300, 300]) %>
        </div>
      <% end %>
    </div>
  <% else %>
    <p>画像はありません</p>
  <% end %>
  
  <p><strong>タグ:</strong>
    <% @post.tags.each do |tag| %>
      <span class="badge badge-info"><%= tag.name %></span>
    <% end %>
  </p>
  <p><strong>〒</strong> <%= @post.postal_code %></p>
  <p><strong>住所:</strong> <%= @post.address %></p>
  <p><strong>評価:</strong>
    <% if @post.comments.any? %>
      平均評価: <strong><%= @post.average_rating.round(1) %></strong> / 5
    <% else %>
      評価なし
    <% end %>
  </p>
  <p><small>投稿者: <%= link_to @post.user.name, user_path(@post.user) %></small></p>
  
  <h3>コメント一覧</h3>
  <% if @post.comments.any? %>
    <ul class="list-group">
      <% @post.comments.each do |comment| %>
        <li class="list-group-item">
          <strong><%= link_to comment.user.name, user_path(comment.user) %>:</strong>
          <p><%= comment.content %></p>
          <small>評価: <strong><%= comment.ratings.average(:score).to_f.round(1) %></strong> / 5</small>
          <small><%= comment.created_at.strftime("%Y-%m-%d %H:%M") %></small>
          <% if comment.user == current_user %>
            <%= link_to '削除', post_comment_path(@post, comment), method: :delete, data: { confirm: '本当に削除しますか？' }, class: 'btn btn-danger btn-sm' %>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% else %>
    <p>コメントはまだありません。</p>
  <% end %>
  
  <%= form_with(model: [@post, @comment], local: true) do |f| %>
    <div class="form-group">
      <%= f.label :content, "コメント" %>
      <%= f.text_area :content, class: "form-control", required: true %>
    </div>
  
    <div class="form-group" id="star">
      <%= f.label :score, "評価" %>
      <%= hidden_field_tag 'rating[score]', nil, id: :rating_score, class: 'form-control' %>
      <div id="rating_raty"></div>
    </div>
  
    <%= f.submit "投稿する", class: "btn btn-primary" %>
  <% end %>
  
  <% if @post.user == current_user %>
    <%= link_to '編集する', edit_post_path(@post), class: 'btn btn-success my-3' %>
  <% end %>
  
  <script>
    $(document).on('turbolinks:load', function() {
      let elem = document.querySelector('#rating_raty');
      if (elem == null) return;
  
      elem.innerHTML = ""
      let opt = {  
        starOn: "<%= asset_path('star-on.png') %>",
        starOff: "<%= asset_path('star-off.png') %>",
        scoreName: 'rating[score]',  // Ratingのスコアを送信
        click: function(score, evt) {
          $('#rating_score').val(score);  // スコアをhidden_fieldに設定
        }
      };
      raty(elem, opt);  // Ratyを初期化
    });
  </script>
</div>